#!/usr/bin/env python
# -*- coding: utf-8; mode: python; -*-

""" Fetches data files from Ministerio del Interior """

from datetime import datetime
from io import BytesIO
from zipfile import is_zipfile, ZipFile

from requests import get, head

from common import CONGRESO, SENADO, get_logger

logger = get_logger(__file__)

PREFIX = 'http://www.infoelectoral.interior.es/docxl/apliext/'


def fetch(u):
    logger.info('Fetching {s:s}'.format(s=u))
    res = PREFIX + u
    logger.info('From {s:s}'.format(s=res))
    t0 = datetime.now()
    x = get(res)
    d = datetime.now() - t0
    logger.info('GET completed after {d:.2f} s.'.format(d=d.total_seconds()))
    logger.info('Content-Type is {b:s}'.format(b=x.headers['Content-Type']))
    try:
        assert(x.headers['Content-Type'] == 'application/zip')
    except AssertionError:
        logger.fatal('Resource content mismatch: {s:s}'.format(s=res))
        return
    xx = BytesIO(x.content)
    logger.info('Expected content is {b:b}'.format(b=is_zipfile(xx)))
    assert(is_zipfile(xx))
    filename = '../tmp/' + u
    logger.info('Saving to {s:s}'.format(s=filename))
    with open(filename, 'wb') as f:
        f.write(x.content)

files = CONGRESO + SENADO
tmp = [fetch(i) for i in files]
